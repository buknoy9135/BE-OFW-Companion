<div class="mb-4 flex justify-between items-center">
  <%= link_to "Back to Dashboard", dashboard_index_path, class: "text-blue-600 hover:underline" %>
  <%= link_to "New Package", new_package_path, class: "bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700" %>
</div>

<h1 class="text-2xl font-bold mb-4">My Packages</h1>

<div class="overflow-x-auto">
  <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tracking Number</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Courier</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
      <% @packages.each do |pkg| %>
        <% latest_event = pkg.latest_event_raw || {} %>
        <% current_status =
             latest_event["stage"].presence ||
             latest_event["sub_status"].to_s.split("_").first.presence ||
             pkg.status.presence || "Unknown" %>
        <% current_status = current_status.gsub(/([a-z])([A-Z])/, '\1 \2').titleize %>

        <% last_location =
             latest_event.dig("address", "city").presence ||
             latest_event.dig("address", "state").presence ||
             pkg.last_location.presence || "Unknown" %>

        <% last_update = latest_event["time_utc"].presence || pkg.last_update %>
        <% last_update_formatted = last_update ? Time.zone.parse(last_update.to_s).strftime("%b %d, %Y %I:%M %p") : "N/A" %>
        <% latest_desc = latest_event["description"].presence || pkg.latest_description.presence || "N/A" %>

        <tr class="hover:bg-gray-50 cursor-pointer" onclick="window.location='<%= package_path(pkg) %>'">
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600"><%= pkg.tracking_number %></td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><%= pkg.courier_name %></td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><%= current_status %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>
