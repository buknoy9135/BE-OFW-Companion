<div>
  <%= render "layouts/sidebar" %>
</div>

<!-- Main Content -->
<div class="flex-1 p-4 sm:p-6 lg:p-10 lg:ml-64 min-h-dvh bg-gray-50">
  <h1 class="text-xl sm:text-2xl font-bold mb-6">Track a New Package</h1>
  
  <!-- Form -->
  <%= form_with url: new_package_path, method: :get, local: true, class: "space-y-4" do |f| %>
    <div>
      <%= f.label :tracking_number, "Tracking Number", class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_field :tracking_number, required: true, class: "mt-1 w-full border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" %>
    </div>
  
    <div>
      <%= f.label :carrier, "Carrier Name / Code (optional)", class: "block text-sm font-medium text-gray-700" %>
      <%= f.search_field :carrier,
          list: "carriers",
          placeholder: "Type to search...",
          class: "mt-1 w-full border rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" %>
  
      <datalist id="carriers">
        <% @carriers.each do |c| %>
          <option value="<%= c["key"] %>"><%= c["_name"] %></option>
        <% end %>
      </datalist>
    </div>
  
    <div>
      <%= f.submit "Track", class: "w-full sm:w-auto bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition" %>
    </div>
  <% end %>

  <!-- Tracking Results Modal -->
  <% valid_details = @tracking_details.reject { |entry| [nil, "NotFound", "Null", "Nil"].include?(entry[:status]) } %>
  <% if valid_details.any? %>
    <div id="resultsModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div class="bg-white w-11/12 max-w-4xl rounded-lg shadow-lg overflow-hidden">
        
        <!-- Modal header -->
        <div class="flex justify-between items-center px-4 py-2 border-b">
          <h2 class="text-lg font-semibold">Tracking Results</h2>
          <button type="button"
            onclick="document.getElementById('resultsModal').classList.add('hidden')" 
            class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>

        <!-- Modal body -->
        <%= form_with url: packages_path, method: :post, local: true do |f| %>
          <div class="p-4 max-h-[500px] overflow-y-auto space-y-6">
            <% valid_details.each do |entry| %>
              <div class="p-4 border rounded-lg bg-gray-50">
                <p><span class="font-semibold">Tracking Number:</span> <%= entry[:tracking_number] %></p>
                <p><span class="font-semibold">Carrier Code:</span> <%= entry[:carrier_code] %></p>
                <p><span class="font-semibold">Carrier Name:</span> <%= entry[:carrier_name] %></p>
                <p><span class="font-semibold">Status:</span> <%= entry[:status].to_s.gsub(/([a-z])([A-Z])/, '\1 \2').titleize %></p>
                <p><span class="font-semibold">Description:</span><%= entry[:status_description] %></p>
                <p><span class="font-semibold">Pick-up Date:</span> <%= entry[:pickup_date] ? Time.use_zone(current_user.time_zone) { entry[:pickup_date].in_time_zone.strftime("%b %d, %Y %I:%M %p") } : "N/A" %></p>
                <p><span class="font-semibold">Days In Transit:</span> <%= entry[:current_days_in_transit] %></p>

                <% if entry[:recipient_phone].present? %>
                  <p><span class="font-semibold">Recipient Phone:</span> <%= entry[:recipient_phone] %></p>
                <% end %>

                <p><span class="font-semibold">Estimated Delivery:</span> <%= entry[:estimated_delivery] || "Not Specified" %></p>
                <p>
                  <span class="font-semibold">Origin:</span>
                  <%= [entry[:origin_city], entry[:origin_state], entry[:origin_country]].select(&:present?).join(", ") %> |
                  <span class="font-semibold">Destination:</span>
                  <%= [entry[:destination_city], entry[:destination_state], entry[:destination_country]].select(&:present?).join(", ") %>
                </p>

                <!-- History -->
                <h3 class="text-md font-semibold mt-4">History Events</h3>
                <% if entry[:events].present? %>
                  <ul class="list-disc pl-5 space-y-1">
                    <% entry[:events].each do |event| %>
                      <li>
                        <%= event["time_utc"] ? Time.use_zone(current_user.time_zone) { event["time_utc"].in_time_zone.strftime("%b %d, %Y %I:%M %p") } : "N/A" %> - 
                        <%= event["location"] %> - 
                        <%= event["description"] %>
                      </li>
                    <% end %>
                  </ul>
                <% else %>
                  <p class="text-gray-500 text-sm">No history events available.</p>
                <% end %>

                <!-- Hidden fields for Add Package -->
                <% latest_event = entry[:events]&.first || {} %>
                <% last_location =
                    latest_event["location"].presence ||
                    [latest_event.dig("address", "city"), latest_event.dig("address", "state")].compact.join(", ").presence ||
                    "Unknown" %>

                <%= hidden_field_tag :tracking_number, entry[:tracking_number] %>
                <%= hidden_field_tag :carrier_code, entry[:carrier_code] %>
                <%= hidden_field_tag :courier_name, entry[:carrier_name] %>
                <%= hidden_field_tag :status, entry[:status] %>
                <%= hidden_field_tag :last_location, last_location %>
                <%= hidden_field_tag :last_update, latest_event["time_utc"] %>
                <%= hidden_field_tag :expected_delivery, entry[:estimated_delivery] %>
                <%= hidden_field_tag :latest_description, entry[:status_description] %>
                <%= hidden_field_tag :latest_stage, entry[:status] %>
                <%= hidden_field_tag :latest_substatus, entry[:sub_status] %>
                <%= hidden_field_tag :tracking_provider, entry[:carrier_name] %>
                <%= hidden_field_tag :tracking_events, entry.to_json %>
                <%= hidden_field_tag :latest_event_raw, entry[:events]&.first.to_json %>
              </div>
            <% end %>
          </div>

          <!-- Modal footer -->
          <div class="flex justify-end gap-2 px-4 py-2 border-t">
            <%= f.submit "âœš Add Package", class: "bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition" %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>