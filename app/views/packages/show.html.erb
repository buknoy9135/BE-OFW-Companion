<div class="flex-1 p-10 lg:ml-64 min-h-dvh bg-gray-50">
  <div class="mb-4">
    <%= link_to "Back to Packages", packages_path, class: "text-blue-600 hover:underline" %>
  </div>
  
  <h1 class="text-2xl font-bold mb-4">Package Details</h1>
  
  <!-- Modal overlay -->
  <div id="packageModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white w-11/12 max-w-3xl rounded-lg shadow-lg overflow-hidden">
  
      <!-- Header inside modal -->
      <div class="flex justify-between items-center px-4 py-2 border-b">
        <h2 class="text-lg font-semibold">Package Details</h2>
        <button onclick="window.location='<%= packages_path %>'" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
      </div>
  
      <!-- Tabs -->
      <div class="flex border-b">
        <button id="infoTabBtn" onclick="showTab('info')" class="px-4 py-2 border-b-2 border-blue-600 text-blue-600">Tracking Details</button>
        <button id="eventsTabBtn" onclick="showTab('events')" class="px-4 py-2 text-gray-500">Event History</button>
        <button id="carrierTabBtn" onclick="showTab('carrier')" class="px-4 py-2 text-gray-500">Carrier Info</button>
      </div>
  
      <!-- Tab contents -->
      <div class="p-4 max-h-[500px] overflow-y-auto">
        <% if @package.full_payload.present? %>
          <% entry_with_stage = @package.full_payload.find do |e|
              e.dig("track_info", "tracking", "providers")&.any? { |p| p["events"]&.any? { |ev| ev["stage"].present? } }
            end %>

          <% if entry_with_stage.present? %>

            <!-- Info Details Tab -->
            <div id="infoTab">
              <% latest_event = entry_with_stage.dig("track_info", "latest_event") || {} %>
              <% stage_value = latest_event["stage"].presence || latest_event["sub_status"].to_s.split("_").first.presence || "Not Specified" %>
              <% location_value = latest_event["location"].presence || [latest_event.dig("address","city"), latest_event.dig("address","state")].select(&:present?).join(", ").presence ||  @package.last_location.presence || "Not Specified" %>
              <% description_value = latest_event["description"].presence || @package.latest_description.presence || "Not Specified" %>
              <% last_update_value = latest_event["time_utc"].presence || @package.last_update %>
              <% pickup_date = (@package.tracking_events.find{ |e| e["stage"] == "PickedUp" }.presence || @package.tracking_events.last)&.dig("time_utc") %>
              <% time_metrics = @package.full_payload.dig(0, "track_info", "time_metrics") || {} %>
      
              <p><strong>Tracking Number:</strong> <%= @package.tracking_number %></p>
              <p><strong>Courier:</strong> <%= @package.courier_name.presence || "N/A" %></p>
              <p><strong>Courier Code:</strong> <%= @package.carrier_code.presence || "N/A" %></p>
              <p><strong>Status:</strong> <%= stage_value.gsub(/([a-z])([A-Z])/, '\1 \2').titleize %></p>
              <p><strong>Pick-up Date:</strong> <%= pickup_date ? Time.use_zone(current_user.time_zone) { pickup_date.in_time_zone.strftime("%b %d, %Y %I:%M %p") } : "Not Specified" %>
              <p><strong>Days In Transit:</strong> <%= time_metrics["days_of_transit_done"].presence || time_metrics["days_of_transit"] %></p>
              <p><strong>Last Location:</strong> <%= location_value %></p>
              <p><strong>Last Update:</strong> <%= last_update_value ? Time.zone.parse(last_update_value.to_s).strftime("%b %d, %Y %I:%M %p") : "N/A" %></p>
              <p><strong>Expected Delivery:</strong> <%= @package.expected_delivery ? @package.expected_delivery.strftime("%b %d, %Y") : "Not Specified" %></p>
              <p><strong>Latest Description:</strong> <%= description_value %></p>
            </div>

            <!-- Event History Tab -->
            <div id="eventsTab" class="hidden">
              <% events = if @package.tracking_events.is_a?(Array)
                  @package.tracking_events
                elsif @package.tracking_events.is_a?(Hash)
                  @package.tracking_events["events"] || []
                else
                  []
                end.sort_by { |e| e["time_utc"] || "" }.reverse %>

              <% events = entry_with_stage.dig("track_info", "tracking", "providers", 0, "events") %>

              <% if events.any? %>
                <ul class="space-y-2">
                  <% events.each do |event| %>
                    <% stage_val = event["stage"].presence || event["sub_status"].to_s.split("_").first.presence || "N/A" %>
                    <% loc_val = event.dig("address","city").presence || event.dig("address","state").presence || event["location"].presence || "Not Specified" %>
                    <% desc_val = event["description"].presence || "N/A" %>
                    <% time_val = event["time_utc"] %>
                    <li class="p-2 border rounded">
                      <p><strong>Stage:</strong> <%= stage_val.gsub(/([a-z])([A-Z])/, '\1 \2').titleize %></p>
                      <p><strong>Description:</strong> <%= desc_val %></p>
                      <p><strong>Location:</strong> <%= loc_val %></p>
                      <p><strong>Time:</strong> <%= time_val ? Time.zone.parse(time_val).strftime("%b %d, %Y %I:%M %p") : "N/A" %></p>
                    </li>
                  <% end %>
                </ul>
              <% else %>
                <p>No events available.</p>
              <% end %>
            </div>

            <!-- Additional Info Tab -->
            <div id="carrierTab" class="hidden p-4">              
              <% provider_info = entry_with_stage.dig("track_info", "tracking", "providers", 0, "provider") || {} %>
              <% latest_event = entry_with_stage.dig("track_info", "tracking", "providers", 0, "events")&.find { |ev| ev["stage"].present? } || {} %>
              <% shipping_info = entry_with_stage.dig("track_info", "shipping_info") || {} %>

              <p><strong>Provider Name:</strong> <%= provider_info["name"].presence || provider_info["alias"] %></p>
              <p><strong>Tel:</strong> <%= provider_info["tel"].presence || "Not Specified" %></p>
              <p><strong>Homepage:</strong> <%= provider_info["homepage"].presence || "Not Specified" %></p>
              <p><strong>Country:</strong> <%= provider_info["country"].presence || "Not Specified" %></p>

              <p>
                <strong>Origin:</strong>
                <%= [shipping_info.dig("shipper_address", "city"), shipping_info.dig("shipper_address", "country")].select(&:present?).join(", ").presence || entry_with_stage["origin_country"].presence || "Not Specified" %> |
                <strong>Destination:</strong>
                <%= [shipping_info.dig("recipient_address", "city"), shipping_info.dig("recipient_address", "country")].select(&:present?).join(", ").presence || entry_with_stage["destination_country"].presence || "Not Specified" %>
              </p>
            </div>
          <% else %>
              <p>No events with actual stage available yet.</p>
            <% end %>
          <% else %>
            <p>No full payload available.</p>
          <% end %>
      </div>

      <!-- Buttons inside footer -->
      <div class="flex justify-end px-4 py-2 border-t space-x-2">
        <button onclick="window.location='<%= packages_path %>'" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Close</button>
        <%= button_to "Delete", package_path(@package), method: :delete,
        data: { turbo_confirm: "Are you sure you want to delete this package?" },
        class: "bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" %>
      </div>
    </div>
  </div>
  
  <script>
    function showTab(tab) {
      const infoTab = document.getElementById('infoTab');
      const eventsTab = document.getElementById('eventsTab');
      const carrierTab = document.getElementById('carrierTab'); // new tab
  
      const infoBtn = document.getElementById('infoTabBtn');
      const eventsBtn = document.getElementById('eventsTabBtn');
      const carrierBtn = document.getElementById('carrierTabBtn'); // new button
  
      // Hide all tabs and reset button styles
      infoTab.classList.add('hidden');
      eventsTab.classList.add('hidden');
      carrierTab.classList.add('hidden');
  
      infoBtn.classList.remove('border-b-2','border-blue-600','text-blue-600');
      infoBtn.classList.add('text-gray-500');
  
      eventsBtn.classList.remove('border-b-2','border-blue-600','text-blue-600');
      eventsBtn.classList.add('text-gray-500');
  
      carrierBtn.classList.remove('border-b-2','border-blue-600','text-blue-600');
      carrierBtn.classList.add('text-gray-500');
  
      // Show the selected tab and highlight its button
      if(tab === 'info') {
        infoTab.classList.remove('hidden');
        infoBtn.classList.add('border-b-2','border-blue-600','text-blue-600');
        infoBtn.classList.remove('text-gray-500');
      } else if(tab === 'events') {
        eventsTab.classList.remove('hidden');
        eventsBtn.classList.add('border-b-2','border-blue-600','text-blue-600');
        eventsBtn.classList.remove('text-gray-500');
      } else if(tab === 'carrier') {
        carrierTab.classList.remove('hidden');
        carrierBtn.classList.add('border-b-2','border-blue-600','text-blue-600');
        carrierBtn.classList.remove('text-gray-500');
      }
    }
  
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('packageModal').classList.remove('hidden');
      showTab('info'); // default tab
    });
  </script>
</div>


